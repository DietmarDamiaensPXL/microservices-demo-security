name: "Continuous Integration Pipeline"
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  code-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-dotnet@v5
      env:
        DOTNET_INSTALL_DIR: "./.dotnet"
      with:
        dotnet-version: '9.0'
    - uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Download Go dependencies
      run: |
        for SERVICE in "shippingservice" "productcatalogservice"; do
          echo "downloading dependencies for $SERVICE..."
          pushd src/$SERVICE
          go mod download
          go mod tidy
          popd
        done

    - name: Go unit tests
      timeout-minutes: 10
      run: |
        for SERVICE in "shippingservice" "productcatalogservice"; do
          echo "testing $SERVICE..."
          pushd src/$SERVICE
          go test
          popd
        done

    - name: C# Unit Tests
      timeout-minutes: 10
      run: |
        dotnet test src/cartservice/

  security-tests:
    runs-on: ubuntu-latest
    needs: code-tests
    permissions:
      contents: write 
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup Trivy
      uses: aquasecurity/setup-trivy@v0.1.0
      with:
        version: 'latest'
    
    - name: Setup OWASP ZAP
      run: |
        docker pull ghcr.io/zaproxy/zaproxy:stable

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
  
    - name: Install Python dependencies
      run: |
        pip install pandas reportlab matplotlib

    - name: Run trivy scan
      run: ./secops-automation/scripts/scan_trivy_k8s.sh
    
    - name: Run owasp zap
      run: ./secops-automation/scripts/scan_zap_baseline.sh
    
    - name: Generate PDF Report
      run: |
        python3 generate_pdf_pipeline.py

    - name: Upload PDF Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report-pdf
        path: secops-automation/pdf/security-report.pdf

    - name: Commit and push security scan results
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add secops-automation/scans/
        git add secops-automation/reports/
        git add secops-automation/pdf/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: add security scan results [skip ci]"
          git push
        fi

  smoke-tests:
    runs-on: ubuntu-latest
    needs: security-tests
    steps:
    - uses: actions/checkout@v5

    - name: Install kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Create kind cluster
      run: |
        kind create cluster --name test-cluster --wait 2m

    - name: Install Skaffold
      run: |
        curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
        chmod +x skaffold
        sudo mv skaffold /usr/local/bin

    - name: Deploy app with Skaffold
      run: |
        skaffold run --default-repo=local

    - name: Wait for pods
      run: |
        set -x
        kubectl wait --for=condition=available --timeout=300s deployment/redis-cart
        kubectl wait --for=condition=available --timeout=300s deployment/adservice
        kubectl wait --for=condition=available --timeout=300s deployment/cartservice
        kubectl wait --for=condition=available --timeout=300s deployment/checkoutservice
        kubectl wait --for=condition=available --timeout=300s deployment/currencyservice
        kubectl wait --for=condition=available --timeout=300s deployment/emailservice
        kubectl wait --for=condition=available --timeout=300s deployment/frontend
        kubectl wait --for=condition=available --timeout=300s deployment/loadgenerator
        kubectl wait --for=condition=available --timeout=300s deployment/paymentservice
        kubectl wait --for=condition=available --timeout=300s deployment/productcatalogservice
        kubectl wait --for=condition=available --timeout=300s deployment/recommendationservice
        kubectl wait --for=condition=available --timeout=300s deployment/shippingservice

    - name: Smoke Test
      run: |
        set -x
        # restart loadgenerator pod to get fresh logs
        kubectl delete pod -l app=loadgenerator
        kubectl wait --for=condition=ready --timeout=120s pod -l app=loadgenerator

        # wait for requests to come in
        REQUEST_COUNT="0"
        ATTEMPTS=0
        MAX_ATTEMPTS=60
        while [[ "$REQUEST_COUNT"  -lt "50" ]] && [[ "$ATTEMPTS" -lt "$MAX_ATTEMPTS" ]]; do
            sleep 5
            REQUEST_COUNT=$(kubectl logs -l app=loadgenerator | grep Aggregated | awk '{print $2}' || echo "0")
            ATTEMPTS=$((ATTEMPTS + 1))
            echo "Attempt $ATTEMPTS: Request count = $REQUEST_COUNT"
        done

        if [[ "$ATTEMPTS" -ge "$MAX_ATTEMPTS" ]]; then
          echo "Timeout waiting for requests. Only got $REQUEST_COUNT requests."
          kubectl logs -l app=loadgenerator
          exit 1
        fi
        # ensure there are no errors hitting endpoints
        ERROR_COUNT=$(kubectl logs -l app=loadgenerator | grep Aggregated | awk '{print $3}' | sed "s/[(][^)]*[)]//g")

        # Generate smoke test report
        echo "============ Smoke Test Report ============" > smoke-test-report.txt
        echo "Date: $(date)" >> smoke-test-report.txt
        echo "Total Requests: $REQUEST_COUNT" >> smoke-test-report.txt
        echo "Total Errors: $ERROR_COUNT" >> smoke-test-report.txt
        echo "" >> smoke-test-report.txt
        echo "Test Result: " >> smoke-test-report.txt
        if [[ "$ERROR_COUNT" -gt "0" ]]; then
          echo "FAILED - Errors detected in loadgenerator" >> smoke-test-report.txt
          cat smoke-test-report.txt
          exit 1
        else
          echo "PASSED - No errors detected" >> smoke-test-report.txt
          cat smoke-test-report.txt
        fi

    - name: Upload Smoke Test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-report
        path: smoke-test-report.txt

    - name: Cleanup cluster
      if: always()
      run: |
        echo "Cleaning up kind cluster"
        kind delete cluster --name test-cluster
